# Шаблоны отчётов и справок

## Обзор

Система шаблонов позволяет создавать и использовать предустановленные шаблоны для генерации отчётов и справок в различных форматах (текст, PDF, DOC).

## Возможности

### Поддерживаемые форматы
- **Текстовый** - простой текстовый формат
- **PDF** - документы в формате PDF
- **DOC/DOCX** - документы Microsoft Word

### Типы шаблонов
- **Отчёт** - для создания аналитических отчётов
- **Справка** - для создания информационных справок

## Использование

### 1. Создание шаблона

1. Нажмите кнопку "Шаблоны отчётов" в чате
2. Нажмите "Создать шаблон"
3. Заполните поля:
   - **Название** - название шаблона
   - **Описание** - краткое описание назначения
   - **Тип** - отчёт или справка
   - **Формат** - текстовый, PDF или DOC
   - **Содержимое** - текст шаблона с переменными

### 2. Переменные в шаблонах

Используйте следующие переменные для динамического контента:

- `{date}` - текущая дата
- `{time}` - текущее время
- `{datetime}` - дата и время
- `{month}` - название текущего месяца
- `{year}` - текущий год
- `{user}` - имя пользователя
- `{session}` - ID сессии

### 3. Использование шаблона

1. Откройте модальное окно шаблонов
2. Выберите нужный шаблон
3. Содержимое шаблона автоматически вставится в поле ввода
4. Отправьте сообщение - система автоматически сгенерирует документ

### 4. Загрузка файлов шаблонов

Для форматов PDF и DOC:
1. Выберите формат "PDF" или "DOC/DOCX"
2. Нажмите "Выбрать файл"
3. Загрузите файл шаблона (максимум 10MB)
4. Сохраните шаблон

## Структура файлов

```
app/
├── components/
│   └── TemplatesModal.tsx    # Модальное окно шаблонов
├── utils/
│   └── templateProcessor.ts  # Утилиты для обработки шаблонов
└── api/
    └── templates/
        └── generate/
            └── route.ts      # API для генерации документов

public/
└── generated/               # Папка для сгенерированных файлов
```

## API Endpoints

### POST /api/templates/generate

Генерирует документ на основе шаблона и данных.

**Параметры:**
```json
{
  "template": {
    "id": "string",
    "name": "string",
    "format": "text|pdf|doc",
    "fileUrl": "string?",
    "type": "report|reference"
  },
  "data": {
    "response": "string",
    "sql_query": "string?",
    "r_script": "string?"
  },
  "format": "text|pdf|doc"
}
```

**Ответ:**
```json
{
  "success": true,
  "fileUrl": "/generated/report_1234567890.pdf",
  "format": "pdf"
}
```

## Хранение данных

Шаблоны сохраняются в `localStorage` браузера под ключом `reportTemplates`.

## Экспорт/Импорт

- **Экспорт**: Нажмите кнопку экспорта в модальном окне для сохранения всех шаблонов в JSON файл
- **Импорт**: Нажмите кнопку импорта для загрузки шаблонов из JSON файла

## Расширение функциональности

### Добавление новых форматов

1. Обновите интерфейс `Template` в `TemplatesModal.tsx`
2. Добавьте обработку в `templateProcessor.ts`
3. Обновите API endpoint в `route.ts`

### Интеграция с внешними сервисами

Для реальной генерации PDF/DOC документов можно интегрировать:
- **PDF**: Puppeteer, jsPDF, PDFKit
- **DOC**: docx, officegen

## Примеры шаблонов

### Отчёт по пользователям
```
Отчёт по пользователям за {date}

Запрос: {sql_query}

Результат: {response}

Сгенерировано: {datetime}
```

### Справка по спортзалам
```
Справка по спортзалам

Дата формирования: {date}
Время: {time}

{response}

SQL запрос: {sql_query}
```

## Устранение неполадок

### Ошибка "Cannot read properties of undefined"
- Убедитесь, что у всех шаблонов есть поле `format`
- Очистите localStorage и перезагрузите страницу

### Файл не генерируется
- Проверьте консоль браузера на наличие ошибок
- Убедитесь, что папка `public/generated` существует
- Проверьте права доступа к папке

### Шаблон не применяется
- Убедитесь, что шаблон сохранен
- Проверьте, что переменные в шаблоне написаны правильно
- Попробуйте перезагрузить страницу 