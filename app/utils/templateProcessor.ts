import { getSessionId } from './storage';

export interface TemplateData {
  id: string;
  name: string;
  content?: string;
  format: 'text' | 'pdf' | 'doc';
  fileUrl?: string;
  type: 'report' | 'reference';
  description?: string;
}

export interface ReportData {
  response: string;
  sql_query?: string;
}

// Функция для получения переменных по умолчанию
export function getDefaultVariables(): Record<string, string> {
  const now = new Date();
  return {
    '{дата_создания}': now.toLocaleDateString('ru-RU'),
    '{период_анализа}': `${now.getMonth() + 1}/${now.getFullYear()}`,
    '{город}': 'Алматы',
    '{общее_количество_залов}': '15',
    '{название_зала}': 'Фитнес-центр "Здоровье"',
    '{адрес}': 'ул. Абая, 123',
    '{список_услуг}': 'тренажеры, бассейн, йога',
    '{график_работы}': '7:00 - 23:00',
    '{телефон/сайт}': '+7 777 123 45 67',
    '{число_с_бассейнами}': '8',
    '{число_круглосуточных}': '3',
    '{средняя_цена}': '25000',
    '{топ_тренировок}': 'йога, пилатес, кроссфит',
    '{зал_1}': 'Фитнес-центр "Здоровье"',
    '{рейтинг_1}': '4.8',
    '{отзывов_1}': '156',
    '{зал_2}': 'Спортзал "Сила"',
    '{рейтинг_2}': '4.5',
    '{отзывов_2}': '89',
    '{район_1}': 'Алмалинский',
    '{число_1}': '5',
    '{район_2}': 'Медеуский',
    '{число_2}': '3',
    '{средняя_активность_в_день}': '120',
    '{активность_1}': '150',
    '{активность_2}': '130',
    '{активность_3}': '110',
    '{рейтинг_3}': '4.5',
    '{активность_4}': '95',
    '{рейтинг_4}': '4.3',
    '{активность_5}': '85',
    '{рейтинг_5}': '4.1',
    '{общее_количество_пользователей}': '1250',
    '{активных_пользователей}': '890',
    '{новых_пользователей_в_месяц}': '45',
    '{средний_возраст}': '28',
    '{популярные_возрастные_группы}': '25-30, 30-35',
    '{топ_города}': 'Алматы, Астана, Шымкент',
    '{средняя_активность_по_городам}': 'Алматы: 150, Астана: 120, Шымкент: 95',
    '{популярные_виды_спорта}': 'футбол, баскетбол, плавание',
    '{тренды_роста}': '+15% в месяц',
    '{прогноз_на_год}': '+180%',
    '{рекомендации}': 'Увеличить количество бассейнов, добавить детские секции',
    '{контакты}': 'support@fitness.kz, +7 777 123 45 67',
    '{веб_сайт}': 'www.fitness.kz',
    '{адрес_офиса}': 'г. Алматы, ул. Абая, 123, офис 456',
    '{рабочие_часы}': 'Пн-Пт: 9:00-18:00, Сб: 10:00-16:00',
    '{социальные_сети}': 'Instagram: @fitness_kz, Facebook: FitnessKazakhstan',
    '{email_поддержки}': 'support@fitness.kz',
    '{телефон_горячей_линии}': '8-800-123-45-67',
    '{часы_поддержки}': '24/7',
    '{среднее_время_ответа}': '2 часа',
    '{процент_удовлетворенности}': '94%',
    '{количество_обращений_в_день}': '25',
    '{популярные_вопросы}': 'расписание, цены, запись',
    '{среднее_время_решения}': '4 часа',
    '{количество_сотрудников}': '45',
    '{опыт_работы_средний}': '5 лет',
    '{образование_сотрудников}': 'высшее спортивное образование',
    '{сертификаты}': 'международные сертификаты тренеров',
    '{награды}': 'Лучший фитнес-центр 2023',
    '{отзывы_клиентов}': '4.8/5 звезд',
    '{количество_отзывов}': '1250+',
    '{положительные_отзывы}': '94%',
    '{средняя_оценка}': '4.8',
    '{количество_регулярных_клиентов}': '890',
    '{процент_возвращаемости}': '87%',
    '{среднее_время_посещения}': '1.5 часа',
    '{популярные_часы}': '18:00-20:00',
    '{загруженность_пик}': '85%',
    '{средняя_загруженность}': '65%',
    '{количество_групповых_занятий}': '25 в день',
    '{количество_персональных_тренировок}': '15 в день',
    '{средняя_стоимость_группового}': '5000 тенге',
    '{средняя_стоимость_персонального}': '15000 тенге',
    '{скидки_для_постоянных}': 'до 20%',
    '{акции_и_бонусы}': 'первое занятие бесплатно',
    '{программы_лояльности}': 'накопительная система баллов',
    '{партнерские_программы}': 'скидки в спортивных магазинах',
    '{корпоративные_программы}': 'скидки для компаний',
    '{детские_программы}': 'спортивные секции для детей',
    '{программы_для_пожилых}': 'оздоровительная гимнастика',
    '{специальные_программы}': 'реабилитация, похудение, набор массы',
    '{экспертиза_тренеров}': 'международные сертификаты',
    '{обучение_персонала}': 'регулярные тренинги',
    '{качество_оборудования}': 'премиум класс',
    '{обновление_оборудования}': 'ежегодно',
    '{чистота_и_гигиена}': 'ежедневная уборка',
    '{безопасность}': 'круглосуточная охрана',
    '{парковка}': 'бесплатная парковка',
    '{душевые}': 'отдельные душевые кабины',
    '{раздевалки}': 'просторные раздевалки',
    '{сауна}': 'финская сауна',
    '{массаж}': 'профессиональный массаж',
    '{спортивное_питание}': 'бар здорового питания',
    '{wi_fi}': 'бесплатный Wi-Fi',
    '{кондиционирование}': 'климат-контроль',
    '{освещение}': 'естественное и искусственное освещение',
    '{музыка}': 'фоновое музыкальное сопровождение',
    '{телевизоры}': 'телевизоры в зоне кардио',
    '{зеркала}': 'зеркала в зоне тренажеров',
    '{коврики}': 'бесплатные коврики для йоги',
    '{полотенца}': 'бесплатные полотенца',
    '{шкафчики}': 'индивидуальные шкафчики',
    '{замки}': 'электронные замки',
    '{фены}': 'фены в раздевалках',
    '{гели_и_шампуни}': 'гели и шампуни',
    '{тапочки}': 'одноразовые тапочки',
    '{халаты}': 'бесплатные халаты',
    '{чай_и_кофе}': 'бесплатный чай и кофе',
    '{вода}': 'бесплатная питьевая вода',
    '{фрукты}': 'свежие фрукты',
    '{протеиновые_коктейли}': 'протеиновые коктейли',
    '{витамины}': 'витаминные добавки',
    '{аминокислоты}': 'аминокислоты',
    '{креатин}': 'креатин',
    '{гейнеры}': 'гейнеры',
    '{жиросжигатели}': 'жиросжигатели',
    '{предтренировочные}': 'предтренировочные комплексы',
    '{послетренировочные}': 'послетренировочные комплексы',
    '{витаминно_минеральные}': 'витаминно-минеральные комплексы',
    '{омега_3}': 'омега-3',
    '{протеин}': 'протеин',
    '{глютамин}': 'глютамин',
    '{bcaa}': 'BCAA',
    '{l_карнитин}': 'L-карнитин',
    '{коэнзим_q10}': 'коэнзим Q10',
    '{магний}': 'магний',
    '{цинк}': 'цинк',
    '{кальций}': 'кальций',
    '{железо}': 'железо',
    '{селен}': 'селен',
    '{хром}': 'хром',
    '{йод}': 'йод',
    '{фтор}': 'фтор',
    '{медь}': 'медь',
    '{марганец}': 'марганец',
    '{молибден}': 'молибден',
    '{кобальт}': 'кобальт',
    '{никель}': 'никель',
    '{ванадий}': 'ванадий',
    '{кремний}': 'кремний',
    '{бор}': 'бор',
    '{литий}': 'литий',
    '{стронций}': 'стронций',
    '{барий}': 'барий',
    '{рубидий}': 'рубидий',
    '{цезий}': 'цезий',
    '{бериллий}': 'бериллий',
    '{скандий}': 'скандий',
    '{иттрий}': 'иттрий',
    '{лантан}': 'лантан',
    '{церий}': 'церий',
    '{празеодим}': 'празеодим',
    '{неодим}': 'неодим',
    '{прометий}': 'прометий',
    '{самарий}': 'самарий',
    '{европий}': 'европий',
    '{гадолиний}': 'гадолиний',
    '{тербий}': 'тербий',
    '{диспрозий}': 'диспрозий',
    '{гольмий}': 'гольмий',
    '{эрбий}': 'эрбий',
    '{тулий}': 'тулий',
    '{иттербий}': 'иттербий',
    '{лютеций}': 'лютеций',
    '{актиний}': 'актиний',
    '{торий}': 'торий',
    '{протактиний}': 'протактиний',
    '{уран}': 'уран',
    '{нептуний}': 'нептуний',
    '{плутоний}': 'плутоний',
    '{америций}': 'америций',
    '{кюрий}': 'кюрий',
    '{берклий}': 'берклий',
    '{калифорний}': 'калифорний',
    '{эйнштейний}': 'эйнштейний',
    '{фермий}': 'фермий',
    '{менделевий}': 'менделевий',
    '{нобелий}': 'нобелий',
    '{лоуренсий}': 'лоуренсий',
    '{резерфордий}': 'резерфордий',
    '{дубний}': 'дубний',
    '{сиборгий}': 'сиборгий',
    '{бohрий}': 'бohрий',
    '{хассий}': 'хассий',
    '{мейтнерий}': 'мейтнерий',
    '{дармштадтий}': 'дармштадтий',
    '{рентгений}': 'рентгений',
    '{коперниций}': 'коперниций',
    '{нихоний}': 'нихоний',
    '{флеровий}': 'флеровий',
    '{московий}': 'московий',
    '{ливерморий}': 'ливерморий',
    '{тенассин}': 'тенассин',
    '{оганесон}': 'оганесон'
  };
}

// Функция для обработки переменных в шаблоне
export function processTemplateVariables(template: string, variables: Record<string, string>): string {
  let processedTemplate = template;
  
  for (const [key, value] of Object.entries(variables)) {
    processedTemplate = processedTemplate.replace(new RegExp(key, 'g'), value);
  }
  
  return processedTemplate;
}

// Функция для генерации документа из шаблона
export async function generateDocumentFromTemplate(
  template: TemplateData,
  data: ReportData,
  sessionId?: string,
  outputFormat?: 'txt' | 'doc' | 'pdf'
): Promise<{ fileUrl: string; format: string }> {
  try {
    console.log('Calling generateDocumentFromTemplate with:', { template, data, outputFormat });
    
    const requestBody = {
      template: {
        id: template.id,
        name: template.name,
        content: template.content || '',
        type: template.type,
        format: template.format
      },
      chatText: data.response,
      sqlQuery: data.sql_query,
      sessionId: sessionId || 'default',
      outputFormat: outputFormat || 'txt'
    };
    
    console.log('Request body:', requestBody);
    
    const response = await fetch('/api/reports/generate', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(requestBody),
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const result = await response.json();
    console.log('API response:', result);
    
    if (!result.success) {
      throw new Error(result.error || 'Failed to generate report');
    }

    const responseData = {
      fileUrl: result.fileUrl,
      format: result.format
    };
    
    console.log('Returning:', responseData);
    return responseData;
  } catch (error) {
    console.error('Error generating report:', error);
    throw error;
  }
} 